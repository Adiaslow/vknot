---
import ResearchHero from "../components/ResearchHero.astro";
import ResearchLayout from "../layouts/ResearchLayout.astro";
import PublicationCard from "../components/PublicationCard";
import LabIconSmall from "../components/LabIconSmall";
import { fetchAbstractFromCrossRef } from "../utils/fetchAbstract";
import { fetchPublicationMetrics } from "../utils/fetchMetrics";

// Fetch publications from ORCID API
const ORCID_ID = "0009-0006-1673-9485";
let publications = [];

try {
  // Get the list of works from ORCID
  const worksResponse = await fetch(
    `https://pub.orcid.org/v3.0/${ORCID_ID}/works`,
    {
      headers: {
        Accept: "application/json",
      },
    }
  );

  if (worksResponse.ok) {
    const worksData = await worksResponse.json();

    // Process each work group (all publications for homepage preview)
    for (const workGroup of worksData.group || []) {
      // Use the first work-summary in each group
      const workSummary = workGroup["work-summary"][0];

      if (workSummary) {
        const title = workSummary.title?.title?.value || "Untitled";

        // Determine venue
        let venue = "In Review";
        if (workSummary["journal-title"]?.value) {
          venue = workSummary["journal-title"].value;
        } else if (workSummary.type === "preprint") {
          venue = "Preprint";
        }

        // Extract DOI from external IDs
        let doi = "";
        let url = "";

        if (workSummary["external-ids"]?.["external-id"]) {
          const doiRecord = workSummary["external-ids"]["external-id"].find(
            (id: any) => id["external-id-type"] === "doi"
          );
          if (doiRecord) {
            doi = doiRecord["external-id-value"];
          }
        }

        // Fetch real abstract and metrics from CrossRef and other sources using DOI
        const [abstract, metrics] = await Promise.all([
          doi ? fetchAbstractFromCrossRef(doi) : Promise.resolve(""),
          doi ? fetchPublicationMetrics(doi) : Promise.resolve({})
        ]);

        // Get URL to publication
        if (workSummary.url?.value) {
          url = workSummary.url.value;
        }

        // Extract full publication date
        let publicationDate = "";
        let year = new Date().getFullYear();

        if (workSummary["publication-date"]) {
          const pubDate = workSummary["publication-date"];
          year = pubDate.year?.value || year;

          if (pubDate.month?.value && pubDate.day?.value) {
            const month = String(pubDate.month.value).padStart(2, "0");
            const day = String(pubDate.day.value).padStart(2, "0");
            publicationDate = `${year}-${month}-${day}`;
          } else if (pubDate.month?.value) {
            const monthNames = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ];
            publicationDate = `${monthNames[pubDate.month.value - 1]} ${year}`;
          } else {
            publicationDate = String(year);
          }
        } else {
          publicationDate = String(year);
        }

        const publication = {
          title: title,
          abstract: abstract,
          venue: venue,
          year: year,
          date: publicationDate,
          type: workSummary.type || "journal-article",
          doi: doi,
          url: url,
          metrics: metrics,
        };

        publications.push(publication);
      }
    }
  }

  // If no publications were found, but API call succeeded, show empty state
  if (publications.length === 0) {
    publications = [
      {
        title: "Building Research Portfolio",
        abstract:
          "Publications and research outputs will appear here as they become available.",
        venue: "ORCID Profile",
        year: new Date().getFullYear(),
        date: String(new Date().getFullYear()),
        doi: "",
        url: "",
        type: "note",
      },
    ];
  }
} catch (error) {
  console.error("Failed to fetch ORCID publications:", error);
  // Publications will remain empty if ORCID fetch fails
  // The page will still display the lab cards at the bottom
}
---

<ResearchLayout
  title="Adam Murray — Research"
  description="Computational research and lab experiments by Adam Murray."
>
  <ResearchHero
    title="Computational Peptide Drug Design & Neuroscience"
    lead="Research in computational peptide drug design and developmental neuroscience using machine learning, evolutionary and stochastic optimization, and statistical and graph-based methods research at UC Santa Cruz and UC Davis."
    accent="Research Focus Areas"
  />

  <section class="flex flex-col gap-8">
    <div class="flex flex-col gap-3">
      <h2 class="text-3xl font-bold text-slate-900 tracking-tight">
        {
          publications.length > 0 &&
          publications[0].title?.startsWith("Research Focus")
            ? "Research Focus Areas"
            : publications.length > 0 &&
                publications[0].title?.startsWith("Building Research")
              ? "Research Portfolio"
              : "Recent Publications"
        }
      </h2>
      <div class="flex flex-col gap-4">
        <p class="text-slate-600 leading-relaxed">
          {
            publications.length > 0 &&
            publications[0].title?.startsWith("Research Focus")
              ? "Current research initiatives across computational biology, neuroscience, and drug discovery."
              : publications.length > 0 &&
                  publications[0].title?.startsWith("Building Research")
                ? "Publications and research outputs will appear here as they become available."
                : "Recent peer-reviewed publications from ongoing research collaborations."
          }
        </p>
        {
          publications.length > 6 &&
            !publications[0].title?.startsWith("Research Focus") &&
            !publications[0].title?.startsWith("Building Research") && (
              <p class="text-sm text-slate-500">
                Showing recent publications.
                <a
                  href="/adam-murray/research/publications"
                  class="text-blue-600 hover:text-blue-700 font-medium ml-1"
                >
                  View all {publications.length} publications →
                </a>
              </p>
            )
        }
      </div>
    </div>
    <div class="flex flex-col gap-8">
      {
        publications
          .slice(0, 6)
          .map((pub, index) => (
            <PublicationCard
              key={index}
              title={pub.title}
              abstract={pub.abstract}
              venue={pub.venue}
              year={pub.year}
              date={pub.date}
              doi={pub.doi}
              url={pub.url}
              type={pub.type}
              metrics={pub.metrics}
              showAbstract={false}
              isIndexPage={true}
              publicationId={`publication-${index}`}
              client:load
            />
          ))
      }
    </div>
  </section>

  <section class="flex flex-col gap-8">
    <div class="flex flex-col gap-3">
      <h2 class="text-3xl font-bold text-slate-900 tracking-tight">Labs</h2>
    </div>
    <div class="grid gap-6 md:grid-cols-3">
      <a
        href="/adam-murray/research/labs#lokey-lab"
        class="group rounded-lg border border-slate-200/60 bg-white p-6 shadow-sm transition-all duration-300 hover:shadow-md hover:border-slate-300/80 hover:-translate-y-0.5 block"
      >
        <div class="flex flex-col gap-3">
          <div
            class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center"
          >
            <LabIconSmall
              icon="VectorSquare"
              rotation="-45deg"
              color="blue"
              client:load
            />
          </div>
          <h3 class="font-bold text-slate-900">Lokey Lab</h3>
          <p class="text-sm text-slate-600 leading-relaxed">
            Development of computational approaches for designing permeable
            cyclic peptides with improved pharmacological properties through
            structure-activity relationship modeling at UC Santa Cruz.
          </p>
        </div>
      </a>
      <a
        href="/adam-murray/research/labs#kim-lab"
        class="group rounded-lg border border-slate-200/60 bg-white p-6 shadow-sm transition-all duration-300 hover:shadow-md hover:border-slate-300/80 hover:-translate-y-0.5 block"
      >
        <div class="flex flex-col gap-3">
          <div
            class="w-12 h-12 rounded-full bg-emerald-100 flex items-center justify-center"
          >
            <LabIconSmall
              icon="BrainCircuit"
              color="emerald"
              client:load
            />
          </div>
          <h3 class="font-bold text-slate-900">Kim Lab</h3>
          <p class="text-sm text-slate-600 leading-relaxed">
            Mapping of the neural circuitry of the developing visual cortex
            through the analysis of experimental anterograde viral tracing data
            at UC Santa Cruz.
          </p>
        </div>
      </a>
      <a
        href="/adam-murray/research/labs#yarov-yarovoy-lab"
        class="group rounded-lg border border-slate-200/60 bg-white p-6 shadow-sm transition-all duration-300 hover:shadow-md hover:border-slate-300/80 hover:-translate-y-0.5 block"
      >
        <div class="flex flex-col gap-3">
          <div
            class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center"
          >
            <LabIconSmall
              icon="Route"
              rotation="-45deg"
              color="purple"
              client:load
            />
          </div>
          <h3 class="font-bold text-slate-900">Yarov-Yarovoy Labs</h3>
          <p class="text-sm text-slate-600 leading-relaxed">
            Development and application of deep learning-based protein design,
            optimization, and validation pipelines for binders targeting ion
            channels at UC Davis.
          </p>
        </div>
      </a>
    </div>
  </section>
</ResearchLayout>
