---
import LabelLayout from "../../layouts/LabelLayout.astro";
import { fetchSpotifyAlbum, transformSpotifyAlbumToRelease } from "../../utils/spotify";
import { releases as releaseConfigs } from "../../data/releases";

// Fetch Spotify data for all releases
const releases = await Promise.all(
  releaseConfigs.map(async (config) => {
    const spotifyAlbum = await fetchSpotifyAlbum(config.spotifyAlbumId);

    if (!spotifyAlbum) {
      throw new Error(`Failed to fetch Spotify album data for ${config.catalogNumber}. Please check your Spotify credentials in .env file.`);
    }

    const spotifyData = transformSpotifyAlbumToRelease(spotifyAlbum);

    return {
      // From Spotify
      title: spotifyData.title,
      artist: spotifyData.artist,
      year: spotifyData.year,
      releaseDate: new Date(spotifyData.releaseDate).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: '2-digit'
      }),
      artwork: spotifyData.artwork,
      tracklist: spotifyData.tracklist.map(track => track.title),
      duration: spotifyData.duration,

      // From config
      catalogNumber: config.catalogNumber,
      genres: config.genres,
      subgenres: config.subgenres,
      style: config.style,
      slug: config.slug,
      description: config.description,
      artistSlug: config.artistSlug,
      vinylArtwork: config.vinylArtwork,
    };
  })
);
---

<LabelLayout
  title="Releases"
  description="Complete discography from Tender Circuits."
>
  <section class="flex flex-col gap-12">
    <div class="card rounded-2xl p-8">
      <div class="flex flex-col gap-4">
        <h1 class="text-4xl font-bold text-white tracking-tight">Discography</h1>
        <p class="text-lg text-slate-300 leading-relaxed max-w-3xl">
          A curated collection of releases exploring the boundaries between
          ambient electronics, experimental composition, and electroacoustic sound
          design.
        </p>
      </div>
    </div>

    <div class="flex flex-col gap-16">
      {
        releases.map((release) => (
          <article class="flex flex-col gap-8">
            {/* Album Artwork - Full width card that affects fur but without glassmorphic styling */}
            {(release.vinylArtwork || release.artwork) && (
              <div class={release.vinylArtwork ? "card vinyl-card w-full" : "card w-full"}>
                <a href={`/tender_circuits/releases/${release.slug}`} class="block">
                  <img
                    src={release.vinylArtwork || release.artwork}
                    alt={`${release.title} album artwork`}
                    class={release.vinylArtwork ? "vinyl-artwork w-full h-auto" : "velvet-artwork-frame w-full h-auto"}
                  />
                </a>
              </div>
            )}

            {/* Release Info - Full width glassmorphic card */}
            <div class="card group rounded-2xl overflow-hidden w-full">
              <div class="flex flex-col gap-8 p-8">
                {/* Release Header */}
                <div class="flex flex-col gap-6">
                <div class="flex flex-col gap-3">
                  <div class="flex items-center gap-3 flex-wrap">
                    <span class="text-xs uppercase tracking-[0.3em] text-emerald-300 bg-emerald-900/30 px-3 py-1 rounded-full">
                      {release.catalogNumber}
                    </span>
                    <span class="text-xs text-slate-400 font-mono">
                      {release.releaseDate}
                    </span>
                  </div>

                  <div class="flex flex-col gap-2">
                    <h2 class="text-3xl font-bold text-white group-hover:text-emerald-100 transition-colors">
                      {release.title}
                    </h2>
                    <p class="text-xl text-slate-300">by {release.artist}</p>
                  </div>

                  <p class="text-slate-400 leading-relaxed max-w-3xl">
                    {release.description}
                  </p>
                </div>

                {/* Genres and Style */}
                <div class="flex flex-wrap gap-2">
                  {release.genres.map((genre) => (
                    <span class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-300 border border-slate-700">
                      {genre}
                    </span>
                  ))}
                  {release.subgenres.map((subgenre) => (
                    <span class="text-xs px-3 py-1 rounded-full bg-fuchsia-900/30 text-fuchsia-300 border border-fuchsia-800/50">
                      {subgenre}
                    </span>
                  ))}
                  <span class="text-xs px-3 py-1 rounded-full bg-slate-700/50 text-slate-400 border border-slate-600/50">
                    {release.style}
                  </span>
                </div>
              </div>

              {/* Track Listing */}
              <div class="flex flex-col gap-4">
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-medium text-slate-400 uppercase tracking-[0.2em]">
                    Tracklist
                  </h3>
                  <span class="text-xs text-slate-500 font-mono">
                    {release.duration}
                  </span>
                </div>

                <div class="grid gap-2">
                  {release.tracklist.map((track, index) => (
                    <div class="flex items-center gap-3 py-2 px-3 rounded-lg hover:bg-slate-800/50 transition-colors">
                      <span class="text-xs text-slate-500 font-mono w-6 text-right">
                        {(index + 1).toString().padStart(2, "0")}
                      </span>
                      <span class="text-slate-300">{track}</span>
                    </div>
                  ))}
                </div>
              </div>

                {/* Actions */}
                <div class="flex items-center gap-4 pt-6 border-t border-slate-800">
                  <a
                    class="inline-flex items-center gap-2 text-sm font-medium text-emerald-300 hover:text-emerald-200 transition-colors"
                    href={`/tender_circuits/releases/${release.slug}`}
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h1m4 0h1m6-7a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <span>Listen</span>
                  </a>

                  <a
                    class="inline-flex items-center gap-2 text-sm font-medium text-slate-400 hover:text-slate-300 transition-colors"
                    href={`/tender_circuits/artists/${release.artistSlug}`}
                  >
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                      />
                    </svg>
                    <span>Artist Profile</span>
                  </a>
                </div>
              </div>
            </div>
            </div>
          </article>
        ))
      }
    </div>

    {/* Future Releases Section */}
    <section class="card rounded-2xl p-8">
      <div class="flex flex-col gap-4 text-center">
        <h2 class="text-2xl font-semibold text-white">Upcoming Releases</h2>
        <p class="text-slate-400 leading-relaxed max-w-2xl mx-auto">
          More ambient and experimental releases are in development. Follow the
          label for announcements and previews.
        </p>
        <div class="pt-2">
          <span class="text-xs text-slate-500 uppercase tracking-[0.2em]">
            More Coming Soon
          </span>
        </div>
      </div>
    </section>
  </section>
</LabelLayout>

